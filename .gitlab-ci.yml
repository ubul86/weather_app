image: docker:latest

stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  COMPOSER_CACHE_DIR: /root/.composer/cache
  NPM_CONFIG_CACHE: /root/.npm

before_script:
  - echo "Create .env from Gitlab CI/CD Variables"
  - cp $ENV_STAGE ./.env
build:
  stage: build
  services:
    - docker:dind
  script:
    - docker-compose up -d --build
    - docker-compose exec -T php composer install
    - docker-compose exec -T php php artisan config:clear
    - docker-compose exec -T php php artisan cache:clear
    - docker-compose exec -T php php artisan config:cache
    - docker-compose exec -T php php artisan jwt:secret
    - docker-compose exec -T php php artisan migrate
    - docker-compose exec -T php php artisan db:seed
    - docker-compose exec -T node npm install
    - docker-compose exec -T node npm run build
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

deploy:
  stage: deploy
  services:
    - docker:dind
  script:
    - echo "Deploying to FTP server"
    - curl -T "path/to/local/file" "ftp://$FTP_SERVER/path/to/remote/file" --user "$FTP_USERNAME:$FTP_PASSWORD"
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'
  #only:
  #  - tags
