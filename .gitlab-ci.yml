image: docker:latest

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  COMPOSER_CACHE_DIR: /root/.composer/cache
  NPM_CONFIG_CACHE: /root/.npm

before_script:
  - echo "ENV_STAGE VARIABLE"
  - cp -f $ENV_STAGE ./.env

docker-build:
  stage: build
  services:
    - docker:dind
  script:
    - docker-compose up -d --build
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

composer:
  stage: build
  dependencies:
    - docker-build
  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - vendor/
  script:
    - docker-compose exec -T php composer install
    - docker-compose exec -T php php artisan key:generate
    - docker-compose exec -T php php artisan config:clear
    - docker-compose exec -T php php artisan cache:clear
    - docker-compose exec -T php php artisan config:cache
    - docker-compose exec -T php php artisan jwt:secret
  artifacts:
    expire_in: 1 month
    paths:
      - vendor/
      - .env
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

npm:
  stage: build
  dependencies:
    - docker-build
  cache:
    key: ${CI_COMMIT_REF_SLUG}-npm
    paths:
      - node_modules/
  script:
    - docker-compose exec -T node npm install
    - docker-compose exec -T node npm run build
  artifacts:
    expire_in: 1 month
    paths:
      - node_modules/
      - public/css/
      - public/js/
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

codestyle:
  stage: test
  dependencies:
    - composer
  script:
    - docker-compose exec -T php composer lint
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

analyse:
  stage: test
  dependencies:
    - composer
  script:
    - docker-compose exec -T php composer analyse
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

phpunit:
  stage: test
  dependencies:
    - composer
  script:
    - docker-compose exec -T php php artisan test
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'

deploy:
  stage: deploy
  services:
    - docker:dind
  script:
    - echo "Deploying to FTP server"
    - curl -T "path/to/local/file" "ftp://$FTP_SERVER/path/to/remote/file" --user "$FTP_USERNAME:$FTP_PASSWORD"
  rules:
    - if: $CI_COMMIT_TAG =~ '/^stage-.*$/'
  #only:
  #  - tags


